generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BiometricLog {
  id         String     @id @default(uuid())
  employeeId String
  timestamp  DateTime
  identifier Identifier

  @@unique([employeeId, timestamp, identifier])
  @@index([employeeId])
  @@index([timestamp])
}

model Admin {
  id              String   @id @default(uuid())
  name            String
  email           String   @unique
  isEmailVerified Boolean  @default(false)
  password        String
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([id])
}

model AdminSettings {
  id        String   @id @default(uuid())
  adminId   String
  isTwoFA   Boolean  @default(false)
  updatedAt DateTime @updatedAt
}

model AdminActiveSessions {
  id        String   @id @default(uuid())
  adminId   String
  token     String
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([adminId])
  @@index([token])
  @@index([expiresAt])
}

model AdminOTP {
  id        String          @id @default(uuid())
  adminId   String
  otp       String
  purpose   AdminOTPPurpose
  expiresAt DateTime

  @@index([adminId])
  @@index([otp])
  @@index([purpose])
  @@index([expiresAt])
}

model Shift {
  id                                                         String    @id @default(uuid())
  shiftName                                                  String    @unique
  weeklyDaysOff                                              String[]
  weeklyHalfDays                                             String[]
  fullShiftEarlyPunchConsiderTimeInMinutes                   Int
  halfShiftEarlyPunchConsiderTimeInMinutes                   Int
  fullShiftStartingTime                                      DateTime
  fullShiftEndingTime                                        DateTime
  halfShiftStartingTime                                      DateTime?
  halfShiftEndingTime                                        DateTime?
  fullShiftGraceInTimingInMinutes                            Int
  fullShiftTimeForFirstPunchBeyondWhichMarkedAbsentInMinutes Int
  halfShiftGraceInTimingInMinutes                            Int?
  halfShiftTimeForFirstPunchBeyondWhichMarkedAbsentInMinutes Int?
  fullShiftGraceOutTimingInMinutes                           Int
  halfShiftGraceOutTimingInMinutes                           Int?
  overtimeMaximumAllowableLimitInMinutes                     Int?
  maximumValidShiftLengthPostRegularEndingTimeInMinutes      Int?
  floorPercentageOfTotalFullShiftForHalfDay                  Float
  ceilingPercentageOfTotalFullShiftForHalfDay                Float
  floorPercentageOfTotalHalfShiftForHalfDay                  Float
  ceilingPercentageOfTotalHalfShiftForHalfDay                Float

  @@index([shiftName])
}

model Employee {
  id              String           @id @default(uuid())
  name            String
  employeeId      String           @unique
  assignedEmail   String           @unique
  password        String
  updatedAt       DateTime         @updatedAt
  teamMemberships TeamMembership[]
  projectMembers  ProjectMember[]

  @@index([assignedEmail])
  @@index([employeeId])
  @@index([id])
}

model EmployeeDetails {
  id                              String           @id @default(uuid())
  employeeId                      String           @unique
  personalEmail                   String
  isPersonalEmailVerified         Boolean          @default(false)
  employmentType                  EmploymentTypes
  employmentStatus                EmploymentStatus
  dateOfJoining                   DateTime
  confirmationDate                DateTime?
  phoneNumber                     String
  emergencyContactNumber          String
  presentAddress                  String
  permanentAddress                String
  aadhaarCardNumber               String
  panCardNumber                   String
  bloodGroup                      BloodGroups
  medicalNotes                    String?
  highestEducationalQualification String
  designation                     String
  department                      String
  bankName                        String
  bankAccountNumber               String
  ifsCode                         String
  assignedShiftId                 String?
}

model EmployeeDetailsAttachments {
  id                      String  @id @default(uuid())
  employeeId              String  @unique
  profilePicture          String?
  bankDetailsProofs       Json?
  identityProofs          Json?
  medicalNotesProofs      Json?
  educationAndSkillsProof Json?
}

model EmployeeSettings {
  id                      String   @id @default(uuid())
  employeeId              String
  isTwoFA                 Boolean  @default(false)
  sendOTPsToPersonalEmail Boolean  @default(false)
  updatedAt               DateTime @updatedAt
}

model EmployeeActiveSessions {
  id         String   @id @default(uuid())
  employeeId String
  token      String
  createdAt  DateTime @default(now())
  expiresAt  DateTime

  @@index([employeeId])
  @@index([token])
  @@index([expiresAt])
}

model EmployeeOTP {
  id         String             @id @default(uuid())
  employeeId String
  otp        String
  purpose    EmployeeOTPPurpose
  expiresAt  DateTime

  @@index([employeeId])
  @@index([otp])
  @@index([purpose])
  @@index([expiresAt])
}

model Holiday {
  id         String   @id @default(uuid())
  date       DateTime @unique
  name       String
  forShiftId String?
  isActive   Boolean  @default(true)

  @@index([date])
}

model Events {
  id          String   @id @default(uuid())
  date        DateTime @unique
  name        String
  description String?
  forShiftId  String?
  isActive    Boolean  @default(true)

  @@index([date])
}

model Leave {
  id                   String      @id @default(uuid())
  employeeId           String
  fromDate             DateTime
  toDate               DateTime
  leaveType            String[]
  otherTypeDescription String?
  applicationNotes     String?
  status               LeaveStatus
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  @@unique([employeeId, fromDate, toDate])
  @@index([employeeId])
  @@index([fromDate, toDate])
}

model LeaveRegister {
  id                 String   @id @default(uuid())
  employeeId         String   @unique
  casualCurrent      Int      @default(0)
  casualCarried      Int      @default(0)
  casualTotal        Int      @default(0)
  sickCurrent        Int      @default(0)
  sickCarried        Int      @default(0)
  sickTotal          Int      @default(0)
  bereavementCurrent Int      @default(0)
  bereavementCarried Int      @default(0)
  bereavementTotal   Int      @default(0)
  maternityCurrent   Int      @default(0)
  maternityCarried   Int      @default(0)
  maternityTotal     Int      @default(0)
  paternityCurrent   Int      @default(0)
  paternityCarried   Int      @default(0)
  paternityTotal     Int      @default(0)
  earnedCurrent      Int      @default(0)
  earnedCarried      Int      @default(0)
  earnedTotal        Int      @default(0)
  compOffCurrent     Int      @default(0)
  compOffCarried     Int      @default(0)
  compOffTotal       Int      @default(0)
  otherCurrent       Int      @default(0)
  otherCarried       Int      @default(0)
  otherTotal         Int      @default(0)
  grandTotal         Int      @default(0)
  lastResetYear      Int
  updatedAt          DateTime @updatedAt
}

model LeaveAttachments {
  id              String   @id @default(uuid())
  leaveId         String   @unique
  attachmentPaths String[]
}

model AttendanceLog {
  id                      String           @id @default(uuid())
  employeeId              String
  punchIn                 DateTime?
  punchOut                DateTime?
  durationInOfficeMinutes Int?
  attendanceDate          DateTime
  attendanceDay           String
  flags                   String[]
  status                  AttendanceStatus
  comments                String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  @@unique([employeeId, attendanceDate])
  @@index([employeeId])
  @@index([punchIn])
  @@index([punchOut])
}

model Hr {
  id              String   @id @default(uuid())
  employeeId      String   @unique
  name            String
  email           String   @unique
  isEmailVerified Boolean  @default(true)
  password        String
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([id])
}

model HrActiveSessions {
  id        String   @id @default(uuid())
  hrId      String
  token     String
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([hrId])
  @@index([token])
  @@index([expiresAt])
}

model HrOTP {
  id        String       @id @default(uuid())
  hrId      String
  otp       String
  purpose   HrOTPPurpose
  expiresAt DateTime

  @@index([hrId])
  @@index([otp])
  @@index([purpose])
  @@index([expiresAt])
}

model HrSettings {
  id        String   @id @default(uuid())
  HrId      String   @unique
  isTwoFA   Boolean  @default(false)
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id         String          @id @default(uuid())
  actorRole  ActorRole
  actorId    String?
  targetRole TargetRole?
  targetId   String?
  ipAddress  String
  userAgent  String
  referrer   String?
  endpoint   String
  action     ActionType
  status     AuditStatusType
  message    String?
  timestamp  DateTime        @default(now())

  @@index([actorRole, actorId])
  @@index([targetRole, targetId])
  @@index([endpoint])
  @@index([action])
  @@index([timestamp])
}

model UserInfraRequest {
  id             String           @id @default(uuid())
  requesterId    String
  requesterRole  ActorRole
  requestType    InfraRequestType
  reason         String
  createdAt      DateTime         @default(now())
  maxIterations  Int?
  currentCount   Int              @default(0)
  logRefs        Json
  status         RequestStatus    @default(pending)
  resolutionNote String?
  respondedAt    DateTime?
  delegatedToHr  Boolean          @default(false)
  isVisibleToHr  Boolean          @default(false)
  adminId        String?
  hrId           String?
  lastHandledBy  ActorRole?

  @@index([requesterId])
  @@index([status])
  @@index([requestType])
}

enum Identifier {
  fingerprint
  card
  unknown
}

enum AttendanceStatusProcessingIdentifiers {
  thirdlate
}

enum AdminOTPPurpose {
  twoFA
  emailVerification
  passwordReset
}

enum BloodGroups {
  A_positive
  A_negative
  B_positive
  B_negative
  AB_positive
  AB_negative
  O_positive
  O_negative
}

enum EmploymentTypes {
  PART_TIME
  FULL_TIME
  INTERN
  CONTRACT
  FREELANCER
}

enum EmploymentStatus {
  EMPLOYED
  RESIGNED
  TERMINATED
  SUSPENDED
  PROBATION
}

enum EmployeeOTPPurpose {
  twoFA
  emailVerification
  passwordReset
}

enum LeaveType {
  CASUAL
  SICK
  EARNED
  UNPAID
  PAID
  COMP_OFF
  MATERNITY
  PATERNITY
  BEREAVEMENT
  LOP
  OTHER
}

enum LeaveStatus {
  pending
  approved
  rejected
  cancelled
}

enum AttendanceStatus {
  fullDay
  halfDay
  overtime
  absent
  approvedLeave
  weeklyOff
  holiday
  anomalous
}

enum AttendanceFlags {
  autoOut
  singleEntry
  late
  earlyOut
  insufficientHours
  firstPunchBeyondCutoff
  invalidOut
  suspicious
  overtime
  manualEntry
  thirdLate
  edited
  approvedLeave
  leaveDocked
  payDocked
}

enum HrOTPPurpose {
  twoFA
  emailVerification
  passwordReset
}

enum ActorRole {
  admin
  hr
  employee
  system
  unauthenticated
}

enum TargetRole {
  admin
  hr
  employee
}

enum ActionType {
  create
  read
  update
  delete
  login
  logout
  access
  verify
  revoke
  promote
  demote
  generate
  send
  upload
  download
}

enum AuditStatusType {
  success
  failure
}

enum InfraRequestType {
  bypass2FA
  resetPassword
  other
}

enum RequestStatus {
  pending
  approved
  denied
}

/// ===============================
/// FINAL PRISMA ADDITIONS / CHANGES
/// Copy-paste into schema.prisma
/// ===============================

/// -------- ORG: Teams (lookup tables for Employee) --------

enum TeamRole {
  leader
  member
}

model Team {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships TeamMembership[]
}

model TeamMembership {
  id         String   @id @default(uuid())
  teamId     String
  employeeId String

  role       TeamRole @default(member)
  joinedAt   DateTime @default(now())
  leftAt     DateTime?

  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([teamId, employeeId])
  @@index([employeeId])
  @@index([teamId, role])
  @@index([teamId, leftAt])
}

/// -------- PM: Projects --------

/// UPDATED: include hr/admin as protected roles in-project
enum ProjectMemberRole {
  lead
  contributor
  hr
  admin
}

enum ProjectStatus {
  planned
  active
  paused
  completed
  cancelled
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(planned)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     ProjectMember[]
  tasks       Task[]

  @@unique([name])
  @@index([status])
}

model ProjectMember {
  id          String            @id @default(uuid())
  projectId   String
  employeeId  String

  role        ProjectMemberRole @default(contributor)
  joinedAt    DateTime @default(now())
  leftAt      DateTime?

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  taskAssignments     TaskAssignment[]
  taskTimelines       TaskTimeline[]
  statusChangesRequested TaskStatusChange[] @relation("TaskStatusRequestedBy")
  statusChangesDecided   TaskStatusChange[] @relation("TaskStatusDecidedBy")

  @@unique([projectId, employeeId])
  @@index([employeeId])
  @@index([projectId, role])
  @@index([projectId, leftAt])
}

/// -------- PM: Tasks --------

enum TaskStatus {
  todo
  in_progress
  blocked
  done
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

model Task {
  id          String       @id @default(uuid())
  projectId   String

  title       String
  description String?

  /// APPROVED truth-status only
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)

  dueAt       DateTime?
  completedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  /// One Task -> Many assigned members
  assignments TaskAssignment[]

  /// Worklog/commit entries
  timeline    TaskTimeline[]

  /// Status change requests + approvals (Task -> many)
  statusChanges TaskStatusChange[] @relation("TaskAllStatusChanges")

  /// Optional: quick pointer for FE to show "pending approval" without scanning (Task -> 0/1)
  latestPendingStatusChangeId String? @unique
  latestPendingStatusChange   TaskStatusChange? @relation("TaskLatestPendingStatusChange", fields: [latestPendingStatusChangeId], references: [id], onDelete: SetNull)

  @@index([projectId, status])
  @@index([projectId, dueAt])
  // @@index([latestPendingStatusChangeId])  // optional; @unique already indexes it
}

/// Join table: Task assigned to many ProjectMembers
model TaskAssignment {
  id              String @id @default(uuid())
  taskId          String
  projectMemberId String

  assignedAt      DateTime @default(now())
  unassignedAt    DateTime?

  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  projectMember   ProjectMember @relation(fields: [projectMemberId], references: [id], onDelete: Cascade)

  @@unique([taskId, projectMemberId])
  @@index([projectMemberId])
  @@index([taskId, unassignedAt])
}

/// -------- PM: Task Timeline (Worklog / Commits) --------
/// NOTE: This is NOT the truth for status. Status uses TaskStatusChange.

enum TaskTimelineKind {
  work_done
  comment
  assignment
  system
}

model TaskTimeline {
  id              String           @id @default(uuid())
  taskId          String
  projectMemberId String

  kind            TaskTimelineKind @default(work_done)

  /// Optional time window
  from            DateTime?
  to              DateTime?

  summary         String
  details         String?

  meta            Json?

  createdAt       DateTime @default(now())

  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  projectMember   ProjectMember @relation(fields: [projectMemberId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@index([projectMemberId, createdAt])
  @@index([kind])
}

/// -------- PM: Approval workflow for Task status changes --------

enum ApprovalStatus {
  pending
  approved
  rejected
}

model TaskStatusChange {
  id                          String @id @default(uuid())

  taskId                      String
  requestedByProjectMemberId  String
  requestedAt                 DateTime @default(now())

  fromStatus                  TaskStatus
  toStatus                    TaskStatus

  /// requester remark (why/what)
  requestRemark               String?

  approvalStatus              ApprovalStatus @default(pending)

  decidedByProjectMemberId    String?
  decidedAt                   DateTime?
  /// decision remark (approved/rejected + why)
  decisionRemark              String?

  /// Main relation: this change belongs to exactly one task (Task -> many TaskStatusChange)
  task                        Task          @relation("TaskAllStatusChanges", fields: [taskId], references: [id], onDelete: Cascade)

  /// Back relation for the "latest pending pointer" (Task -> 0/1 TaskStatusChange)
  latestPendingForTask        Task?         @relation("TaskLatestPendingStatusChange")

  requestedBy                 ProjectMember @relation("TaskStatusRequestedBy", fields: [requestedByProjectMemberId], references: [id], onDelete: Cascade)
  decidedBy                   ProjectMember? @relation("TaskStatusDecidedBy", fields: [decidedByProjectMemberId], references: [id], onDelete: SetNull)

  @@index([taskId, requestedAt])
  @@index([approvalStatus])
  @@index([requestedByProjectMemberId])
  @@index([decidedByProjectMemberId])
}
